# 综合学习计划：区块链钱包 + Web2 架构实战

## 目标

掌握区块链钱包开发的核心技术，并在此过程中强化高级 Go 后端技能（高并发、Redis、Postgres、K8s、CI/CD）。

## 策略

我们将构建一个 **"混合架构钱包平台"** 作为核心实战项目。该平台将模拟一个简化的加密货币交易所或钱包服务提供商后端。这种设计允许我们将 Web2 的架构解决方案应用到 Web3 的业务场景中。

## 模块分解与技术集成点

### 模块 1: 密码学与安全基础 (Module 1: Cryptography & Security)

**Web3 重点:** ECDSA, Ed25519, 哈希算法, 助记词/种子管理。
**Web2 集成点:**

- **Go 最佳实践:** 设计清晰、可测试的接口 (Interfaces) 来封装不同的加密算法。
- **安全性:** 内存安全、敏感数据处理（如在使用后清除内存中的私钥）、防止侧信道攻击（基础概念）。

### 模块 2: 钱包核心 (Module 2: The Wallet Core - HD Wallets)

**Web3 重点:** BIP-39 (助记词), BIP-32/44 (派生路径), 地址生成。
**Web2 集成点:**

- **库设计 (Library Design):** 创建可复用的 Go module/package。
- **单元测试 (Unit Testing):** 对关键的密钥生成逻辑进行全覆盖的测试。

### 模块 3: 中心化钱包后端 (Module 3: Centralized Wallet Backend - "重头戏")

_这是 Web2 概念应用最密集的模块。_
**Web3 重点:** 扫描区块、检测充值、签名提现、管理 UTXO/Nonce。
**Web2 集成点:**

- **数据库设计 (Postgres):** 设计稳健的财务系统数据库模型 (必须满足 ACID)。处理余额更新时的乐观锁 (Optimistic Locking)。
- **高并发 (High Concurrency):**
  - **区块扫描器:** 使用 Go routines 和 channels 并行获取和处理区块（在链顺序允许的情况下）或流水线处理。
  - **交易队列:** 使用 Redis 或 Kafka (简化版可用 Redis Streams) 异步处理提现请求。
- **缓存 (Redis):** 缓存最新的区块高度、Gas 价格或用户余额（Write-through/Write-back 策略）。
- **分布式锁 (Distributed Locks):** 确保同一时间只有一个服务实例在处理特定区块或为特定地址签名，防止双花。

### 模块 4: API 网关与用户服务 (Module 4: API Gateway & User Services)

**Web3 重点:** 代理 RPC 调用、解析交易历史。
**Web2 集成点:**

- **API 框架:** Gin 或 Echo。
- **中间件:** 认证 (JWT)、日志 (Logging)、Prometheus 监控指标、限流 (Token Bucket in Redis)。
- **文档:** Swagger/OpenAPI 自动生成。

### 模块 5: 资金归集与热钱包 (Module 5: Funds Collection & Hot Wallet)

**Web3 重点:** 私钥派生 (Key Derivation), EIP-155 签名, Gas 估算, 交易广播.
**Web2 集成点:**

- **任务队列:** 消费 Module 3 的充值消息.
- **分布式锁:** 防止多实例对同一笔 Deposit 进行归集.
- **安全架构:**
  - **Cold/Hot Wallet:** 区分冷热钱包概念.
  - **Key Management:** 演示如何在内存中通过 Master Key + Path 派生私钥，用完即焚.

#### [NEW] [collection.go](file:///Users/dwoura/Desktop/Code/学习/go 后端开发学习/区块链钱包开发学习/wallet-core/internal/model/collection.go)

- 定义 `Collection` 数据库模型.

#### [NEW] [sweeper_service.go](file:///Users/dwoura/Desktop/Code/学习/go 后端开发学习/区块链钱包开发学习/wallet-core/pkg/wallet/service/sweeper_service.go)

- 实现归集逻辑: 监听 MQ -> 获取私钥 -> 构造交易 -> 签名 -> 广播 -> 落库.

#### [NEW] [utils/lock](file:///Users/dwoura/Desktop/Code/学习/go 后端开发学习/区块链钱包开发学习/wallet-core/pkg/utils/lock/redis_lock.go)

- 实现 Redis 分布式锁，防止多实例并发归集.

### 模块 6: 基础设施与运维 (Module 6: Infrastructure - DevOps)

**Web3 重点:** 运行全节点 (模拟或使用 Infura/Alchemy)、安全隔离环境 (模拟 TEE)。
**Web2 集成点:**

- **Docker:** 为每个微服务编写 Dockerfile (Scanner, Signer, API)。
- **Docker Compose:** 本地开发环境编排。
- **K8s:** 将服务栈部署到本地 Kind/Minikube 集群。
- **CI/CD:** 使用 GitHub Actions 在推送代码时自动运行测试、Lint 检查和构建镜像。

#### [NEW] [Dockerfile](file:///Users/dwoura/Desktop/Code/学习/go 后端开发学习/区块链钱包开发学习/wallet-core/Dockerfile)

- 多阶段构建: Build Stage (Golang Image) -> Run Stage (Alpine Image).

#### [MODIFY] [docker-compose.yml](file:///Users/dwoura/Desktop/Code/学习/go 后端开发学习/区块链钱包开发学习/wallet-core/docker-compose.yml)

- 新增 `wallet-server` 服务，挂载配置文件，连接 `wallet-db` 和 `wallet-redis`.

### 模块 8: 去中心化钱包 (Module 8: Decentralized Wallet) [DONE]

- **本地 Keystore:** 学习 keystore JSON 格式 (AES-256-GCM + Scrypt). _[文档](./docs/module_8_guide_keystore.md)_
- **离线签名:** 构造 Raw Transaction 并签名，不触网. _[文档](./docs/module_8_guide_offline_signing.md)_
- **API 网关:** 封装 RPC 接口，提供统一的 RESTful API 给移动端.

### 模块 9: 高级概念 (Module 9: Advanced Concepts)

- **MPC (多方计算):** 简单的 TSS 签名演示.
- **Account Abstraction (ERC-4337):** 简单的 UserOperation 构造.

### 模块 9: 企业级架构升级 (Module 9: Enterprise Architecture)

- **Kafka 迁移:** 生产级 MQ 接入 (已完成).
- **分布式事务:** Transactional Outbox 模式 (已完成).

### 模块 10: 工程化标准与微服务 (Module 10: Engineering Standards & Microservices) [NEW]

**目标:** 打造"看起来非常专业"的代码库，符合大厂开发规范。

- **Project Layout:** 遵循 `golang-standards/project-layout` 重构目录.
  - `cmd/`: 及其入口.
  - `internal/`: 私有业务逻辑 (Domain, Service, Repo).
  - `pkg/`: 可复用库 (Utils, Middlewares).
  - `api/`: Protobuf 定义, Swagger 文档.
- **统一响应 (Response Wrapper):**
  - Standard JSON: `{ "code": 1000, "msg": "success", "data": {...} }`.
  - Global Error Handling: 统一错误码拦截.
- **RPC 通信 (gRPC):**
  - 定义 `.proto` 文件描述服务接口.
  - 使用 `protoc` 生成 Go 代码.
  - 实现 gRPC Server 和 Client，替代部分 HTTP 调用.

### 模块 11: 生产级工程化 (Module 11: Production Readiness) [NEW]

- **定时任务 (Cron Jobs):**
  - 使用 `robfig/cron`。
  - 实战: 定时同步币种汇率 (Fiat Exchange Rates)。
- **多级缓存 (Multilevel Caching):**
  - 使用 `patrickmn/go-cache` (In-Memory)。
  - 实战: 缓存支持的币种列表 (SupportedCurrencies)，减少 DB 压力。
- **输入校验 (Input Validation):**
  - 使用 `go-playground/validator`。
  - 实战: 校验注册接口的邮箱格式、密码强度。
- **结构化日志 (Structured Logging):** 引入 Zap, JSON 格式, Context 关联.
- **优雅停机 (Graceful Shutdown):** 确保零数据丢失.
- **配置管理 (Configuration):** Viper 集成, 支持 YAML/Env.

### 模块 12: 最佳实践与测试 (Module 12: Best Practices & Testing) [NEW]

**目标:** 建立稳固的质量保障体系和清晰的工程结构。

- **目录结构优化:**
  - 引入 `internal/server` 封装启动逻辑。
  - 区分 `handler/app` (用户端) 与 `handler/admin` (管理端)。
- **DTO 分离:**
  - 杜绝在 API 层直接暴露数据库模型 (`internal/model`)。
  - 建立 `internal/handler/request/` 和 `response/`。
- **测试体系 (Testing Strategy):**
  - **单元测试 (Unit):** 针对 `internal/service`，使用 Mock 隔离依赖。
  - **集成测试 (Integration):** 针对 API 接口，启动真实 Docker 环境验证链路。

## 下一步计划

1.  **环境初始化:** 初始化 Go 项目结构。
2.  **仓库配置:** 配置 pre-commit hooks 和 CI 基础。
3.  **启动模块 1:** 实现基础的密钥对生成功能 (Key Pair generation)。
